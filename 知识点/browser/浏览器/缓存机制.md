![](https://chenjing-oss.oss-cn-hangzhou.aliyuncs.com/typora/image-20220314202754170.png)

##### 什么是浏览器缓存

<img src="https://chenjing-oss.oss-cn-hangzhou.aliyuncs.com/typora/image-20220314193315182.png" alt="image-20220314193315182"  />

# 缓存资源一般放在哪里？

- Service Worker:运行在浏览器背后的独立线程，一般可以用来实现缓存功能
- Memory Cache:内存中的缓存
- Disk Cache:硬盘中的缓存
- Push Cache:（推送缓存）是 HTTP/2 中的内容，当以上三种缓存都没有命中时，它才会被使用

| 缓存资源       | 特点                                                         |
| -------------- | ------------------------------------------------------------ |
| Service Worker | 1.浏览器独有<br />2.自由控制缓存哪些文件<br />3.必须使用 HTTPS 协议 |
| Memory Cache   | 1.持续性很短，会随着进程的释放而释放                         |
| Disk Cache     | 1.HTTP Herder 中的字段判断哪些资源需要缓存                   |
| Push Cache     | 在Chrome浏览器中只有5分钟左右                                |

查找浏览器缓存时会按顺序查找: Service Worker-->Memory Cache-->Disk Cache-->Push Cache

# 三级缓存原理 (访问缓存优先级)

1. 先在内存中查找,如果有,直接加载。
2. 如果内存中不存在,则在硬盘中查找,如果有直接加载。
3. 如果硬盘中也没有,那么就进行网络请求。
4. 请求获取的资源缓存到硬盘和内存。



# 浏览器缓存的分类

> 浏览器再向服务器请求资源时,首先判断是否命中强缓存,再判断是否命中协商缓存!

### 强缓存

强缓存是当我们访问URL的时候，不会向服务器发送请求，直接从缓存中读取资源，但是会返回200的状态码。

#### 如何设置强缓存？

| request header | 生效的状态码 | 优先级 | 条件    | 值                                                           |
| -------------- | ------------ | ------ | ------- | ------------------------------------------------------------ |
| expires        | 200          | 低     | HTTP1.0 | 本地时间戳<过期时间                                          |
| cache-control  | 200          | 高     | HTTP1.1 | 1.max-age：缓存保质期 <br />2.public：资源客户端和服务器都可以缓存。 3.privite：资源只有客户端可以缓存。<br />4.no-cache：客户端缓存资源，但是是否缓存需要经过协商缓存来验证。 <br />5.no-store：不使用缓存。 |



### 协商缓存

协商缓存就是<u>强缓存失效后</u>，浏览器携带缓存标识向服务器发送请求，<u>由服务器根据缓存标识来决定是否使用缓存的过程。</u>

![image-20220314201216268](https://chenjing-oss.oss-cn-hangzhou.aliyuncs.com/typora/image-20220314201216268.png)

![image-20220314201301399](https://chenjing-oss.oss-cn-hangzhou.aliyuncs.com/typora/image-20220314201301399.png)



#### **如何设置协商缓存？**

| request header    | Response header |                                                              |
| ----------------- | --------------- | ------------------------------------------------------------ |
|                   | Last-Modified   | 是服务器响应请求时，返回该资源文件在服务器最后被修改的时间。 |
| If-Modified-Since |                 | If-Modified-Since则是客户端再次发起该请求时，携带上次请求返回的Last-Modified值，服务器则会根据If-Modified-Since的字段值与该资源在服务器的最后被修改时间做对比，若服务器的资源最后被修改时间大于If-Modified-Since的字段值，则重新返回资源，状态码为200；否则则返回304，代表资源无更新，可继续使用缓存文件。 |
|                   | Etag            | 服务器**响应**请求返回当前资源文件的一个唯一标识(由服务器生成)。 |
| If-None-Match     |                 | If-None-Match是客户端再次发起该请求时，携带上次请求返回的唯一标识Etag值，会和服务器的Etag值做对比，一致则返回304，代表资源无更新，继续使用缓存文件；不一致则重新返回资源文件，状态码为200。 |

**Etag / If-None-Match优先级高于Last-Modified / If-Modified-Since，同时存在则只有Etag / If-None-Match生效。** 

### 强缓存与协商缓存的区别

- 强缓存不发请求到服务器，所以有时候资源更新了浏览器还不知道，但是协商缓存会发请求到服务器，所以资源是否更新，服务器肯定知道。
- 大部分web服务器都默认开启协商缓存。

### 刷新对于强缓存和协商缓存的影响

- [ ] 当ctrl+f5强制刷新网页时，直接从服务器加载，跳过强缓存和协商缓存。
- [ ] 当f5刷新网页时，跳过强缓存，但是会检查协商缓存。
- [ ] 浏览器地址栏中写入URL，回车 浏览器发现缓存中有这个文件了，不用继续请求了，直接去缓存拿。（最快）

